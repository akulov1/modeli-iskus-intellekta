{% extends "base.html" %}
{% block content %}
  <div class="card">
    <h1>Рекомендательная система планирования переезда</h1>
    <div class="small">
      Город отправления фиксирован: <span class="pill">{{ origin_city.label if origin_city else "Краснодар" }}</span>
    </div>
  </div>

  <form class="card" method="post" action="/recommend" id="moveForm">
    <h2>Данные переезда</h2>

    <div class="grid">
      <div>
        <label>Тип переезда</label>
        <select name="move_type" id="move_type">
          {% for k, v in move_types.items() %}
            <option value="{{ k }}">{{ v }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label>Город назначения (из доступных)</label>
        <select name="destination" required>
          {% for c in dest_cities %}
            <option value="{{ c.iri }}">{{ c.label }}</option>
          {% endfor %}
        </select>
        <div class="small">Для заграницы выберите город с кодом страны ≠ RU.</div>
      </div>

      <div>
        <label>Желаемый бюджет (₽)</label>
        <input name="desired_budget" type="number" step="0.01" min="0" value="80000">
      </div>

      <div>
        <label>Желаемая дата переезда (необязательно)</label>
        <input name="desired_move_date" type="date">
        <div class="small">Если не указать, предложим ближайшую реалистичную дату.</div>
      </div>
    </div>

    <div class="card" style="background:#fbfbff;">
      <h2>Работа (опционально)</h2>
      <div class="row">
        <label style="margin:0;"><input type="checkbox" name="has_work"> Есть работа</label>
        <label style="margin:0;"><input type="checkbox" name="needs_permit"> Требуется разрешение на работу</label>
        <label style="margin:0;"><input type="checkbox" name="employer_covers"> Работодатель покрывает переезд</label>
      </div>
      <div class="small">Логика в этой версии влияет на рекомендуемый бюджет (если покрывает — пользовательская доля меньше).</div>
    </div>

    <div class="card" style="background:#fbfbff;">
      <h2>Список вещей (переменное количество)</h2>

      <div class="small">Добавляйте строки. Стоимость зависит от количества предметов.</div>

      <div id="items"></div>

      <div class="row" style="margin-top:10px;">
        <button type="button" class="btn secondary" onclick="addItem()">+ Добавить предмет</button>
        <div class="small" style="text-align:right;">Если не хотите перечислять, задайте только количество ниже.</div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Количество предметов (если список пуст)</label>
          <input name="items_count" type="number" min="0" step="1" value="0">
        </div>
        <div></div>
      </div>
    </div>

    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button class="btn" type="submit">Сгенерировать рекомендации</button>
    </div>
  </form>

  <script>
    let idx = 0;

    function addItem(prefillName="", prefillVol="", prefillFragile=false) {
      const root = document.getElementById("items");
      const row = document.createElement("div");
      row.className = "card";
      row.style.margin = "12px 0";
      row.innerHTML = `
        <div class="row">
          <div>
            <label>Название</label>
            <input type="text" name="item_name" placeholder="Например: телевизор" value="${prefillName}">
          </div>
          <div>
            <label>Объём (литры, необязательно)</label>
            <input type="number" name="item_volume" step="0.1" min="0" value="${prefillVol}">
          </div>
          <div style="flex:0.7;">
            <label>Хрупкий</label>
            <label class="small" style="display:flex; gap:8px; align-items:center;">
              <input type="checkbox" ${prefillFragile ? "checked" : ""} onchange="syncFragile(this, ${idx})">
              Да
            </label>
            <input type="hidden" name="item_fragile_idx" value="" id="frag_${idx}">
          </div>
          <div style="flex:0.5;">
            <label>&nbsp;</label>
            <button type="button" class="btn secondary" onclick="this.closest('.card').remove()">Удалить</button>
          </div>
        </div>
      `;
      root.appendChild(row);

      // initial sync
      const cb = row.querySelector('input[type="checkbox"]');
      syncFragile(cb, idx);

      idx += 1;
    }

    function syncFragile(checkbox, index) {
      const hidden = document.getElementById("frag_" + index);
      hidden.value = checkbox.checked ? String(index) : "";
    }

    // По умолчанию 2 предмета для удобства проверки
    addItem("Ноутбук", "4", true);
    addItem("Коробка одежды", "35", false);
  </script>
{% endblock %}
